<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages - Avocado</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <!-- ============ HEADER ============ -->
  <header>
    <div class="header-container">
      <a href="../index.html" class="logo-section" style="text-decoration: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48">
          <path fill="#795548" d="M28,10c-0.6,0-1-0.4-1-1c0-3.4,2.2-5.6,2.3-5.7c0.4-0.4,1-0.4,1.4,0c0.4,0.4,0.4,1,0,1.4 c0,0-1.7,1.8-1.7,4.3C29,9.6,28.6,10,28,10z"/>
          <path fill="#558b2f" d="M25.1,7C17.5,7,10,20.4,10,32c0,8,6.4,13,14,13s14-5,14-13c0-9.5-5.6-11.3-5.6-20.8 C32.4,8.7,30,8,28,8C27.2,8,27,7,25.1,7z"/>
          <path fill="#dce775" d="M33.4,22.5c-1.4-2.8-3-6.1-3-11.3c0-1.1-1.9-1.2-2.4-1.2c-0.9,0-1.6-0.4-1.9-0.7 c-0.3-0.2-0.4-0.3-1-0.3C19,9,12,21.3,12,32c0,7.2,6,11,12,11s12-3.8,12-11C36,27.7,34.8,25.2,33.4,22.5z"/>
          <path fill="#fff59d" d="M15,33c0-5,4-16,9-16s9,11,9,16s-4,9-9,9S15,38,15,33z"/>
          <path fill="#962005" d="M30,33c0,3.3-2.7,6-6,6s-6-2.7-6-6s2.7-10,6-10S30,29.7,30,33z"/>
          <path fill="#bf360c" d="M24,23c-3.3,0-6,6.7-6,10c0,0.4,0,0.7,0.1,1.1C19,35.3,20.4,36,22,36c4,0,6-2.2,6-5 c0-3.9-0.8-6-1.9-7.1C25.4,23.3,24.7,23,24,23z"/>
        </svg>
        <span>AVOCADO</span>
      </a>
      
      <nav>
        <a href="../index.html">HOME</a>
        <a href="marketplace.html">MARKETPLACE</a>
        <a href="quad.html">THE QUAD</a>
        <a href="dorm-alerts.html">ALERTS</a>
        <a href="messages.html" class="active">MESSAGES</a>
      </nav>

      <div class="user-section">
        <div class="cart-icon" onclick="openNotifications()">
          ðŸ””
          <span class="cart-count" id="notification-count">0</span>
        </div>
        <div class="user-profile" id="user-profile-btn" onclick="openUserMenu()">
          <span id="user-initial">A</span>
        </div>
      </div>
    </div>
  </header>

  <!-- PAGE CONTENT -->
  <div class="container">
    <div style="max-width: 1000px; margin: 40px auto; display: grid; grid-template-columns: 300px 1fr; gap: 30px; min-height: 70vh;">
      
      <!-- Conversations List -->
      <div style="background-color: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); height: fit-content;">
        <div style="padding: 20px; border-bottom: 1px solid #e0d5cc;">
          <h2 style="font-size: 18px; font-weight: 700;">Conversations</h2>
        </div>
        <div id="conversations-list" style="max-height: 600px; overflow-y: auto;">
          <!-- Conversations loaded by JavaScript -->
        </div>
      </div>

      <!-- Chat Area -->
      <div id="chat-area" style="display: none;">
        <div style="background-color: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); height: 100%; display: flex; flex-direction: column;">
          <!-- Chat Header -->
          <div style="padding: 20px; border-bottom: 1px solid #e0d5cc; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="chat-header-name" style="margin: 0; font-size: 16px; font-weight: 600;"></h3>
            <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;" onclick="closeChat()">Close</button>
          </div>

          <!-- Messages -->
          <div id="messages-container" style="flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px;">
            <!-- Messages loaded by JavaScript -->
          </div>

          <!-- Message Input -->
          <div style="padding: 20px; border-top: 1px solid #e0d5cc;">
            <form onsubmit="sendChatMessage(event)" style="display: flex; gap: 10px;">
              <input type="text" id="chat-input" placeholder="Type a message..." style="flex: 1; padding: 10px 12px;" required>
              <button type="submit" class="btn btn-primary" style="padding: 10px 20px;">Send</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" style="background-color: #f5f1ed; border-radius: 4px; padding: 60px 20px; text-align: center;">
        <p style="font-size: 48px; margin-bottom: 12px;">ðŸ’¬</p>
        <p class="text-muted">Select a conversation to start messaging</p>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>ABOUT AVOCADO</h3>
        <p style="font-size: 14px; color: #ccc; margin-bottom: 12px;">Connect with fellow students.</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2026 Avocado. All rights reserved.</p>
    </div>
  </footer>

  <div class="modal" id="user-menu-modal">
    <div class="modal-content" style="max-width: 350px; margin-top: -200px;">
      <div class="modal-header">
        <h2 class="modal-title">Account</h2>
        <button class="modal-close" onclick="closeUserMenu()">&times;</button>
      </div>
      <div id="user-menu-content"></div>
    </div>
  </div>

  <div class="modal" id="login-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Sign In</h2>
        <button class="modal-close" onclick="closeLoginModal()">&times;</button>
      </div>
      <form onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" required>
        </div>
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Sign In</button>
      </form>
    </div>
  </div>

  <script src="../js/auth.js"></script>
  <script src="../js/marketplace.js"></script>
  <script src="../js/main.js"></script>
  <script>
    let currentConversation = null;

    function loadConversations() {
      if (!currentUser) {
        document.getElementById('conversations-list').innerHTML = '<p class="text-muted" style="padding: 20px;">Please sign in to view messages</p>';
        return;
      }

      const messages = JSON.parse(localStorage.getItem('avocado_messages')) || [];
      
      // Get unique conversations
      const conversations = {};
      
      messages.forEach(msg => {
        if (msg.sender_id === currentUser.id || msg.receiver_id === currentUser.id) {
          const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
          const otherUser = users.find(u => u.id === otherId);
          
          if (!conversations[otherId]) {
            conversations[otherId] = {
              user_id: otherId,
              user_name: otherUser?.name || 'Unknown',
              last_message: msg.message,
              last_date: msg.timestamp,
              unread: msg.receiver_id === currentUser.id && !msg.read
            };
          }
        }
      });

      const convList = document.getElementById('conversations-list');
      
      if (Object.keys(conversations).length === 0) {
        convList.innerHTML = '<p class="text-muted" style="padding: 20px;">No messages yet</p>';
        return;
      }

      convList.innerHTML = Object.values(conversations)
        .sort((a, b) => new Date(b.last_date) - new Date(a.last_date))
        .map(conv => `
          <div onclick="openConversation(${conv.user_id})" style="padding: 16px; border-bottom: 1px solid #e0d5cc; cursor: pointer; background-color: ${currentConversation?.user_id === conv.user_id ? '#f5f1ed' : 'transparent'}; transition: background-color 0.2s;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
              <strong>${conv.user_name}</strong>
              ${conv.unread ? '<span style="background-color: #558b2f; color: white; border-radius: 50%; width: 8px; height: 8px; display: block;"></span>' : ''}
            </div>
            <p style="font-size: 13px; color: #666; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${conv.last_message}</p>
            <p style="font-size: 11px; color: #999; margin: 4px 0 0 0;">${formatDate(conv.last_date)}</p>
          </div>
        `).join('');
    }

    function openConversation(userId) {
      if (!currentUser) {
        openLoginModal();
        return;
      }

      const otherUser = users.find(u => u.id === userId);
      if (!otherUser) return;

      currentConversation = { user_id: userId, user_name: otherUser.name };

      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('chat-area').style.display = 'flex';
      document.getElementById('chat-header-name').textContent = otherUser.name;

      loadMessages(userId);
    }

    function closeChat() {
      currentConversation = null;
      document.getElementById('chat-area').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
    }

    function loadMessages(userId) {
      const messages = JSON.parse(localStorage.getItem('avocado_messages')) || [];
      const conversation = messages.filter(m => 
        (m.sender_id === currentUser.id && m.receiver_id === userId) ||
        (m.sender_id === userId && m.receiver_id === currentUser.id)
      ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      const container = document.getElementById('messages-container');
      container.innerHTML = conversation.map(msg => {
        const isOwn = msg.sender_id === currentUser.id;
        return `
          <div style="display: flex; justify-content: ${isOwn ? 'flex-end' : 'flex-start'}; margin-bottom: 8px;">
            <div style="background-color: ${isOwn ? '#558b2f' : '#e0d5cc'}; color: ${isOwn ? 'white' : '#333'}; padding: 12px 16px; border-radius: 12px; max-width: 70%;">
              <p style="margin: 0; font-size: 14px;">${msg.message}</p>
              <p style="font-size: 11px; ${isOwn ? 'color: rgba(255,255,255,0.7);' : 'color: #666;'} margin: 4px 0 0 0;">
                ${new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
              </p>
            </div>
          </div>
        `;
      }).join('');

      // Mark as read
      messages.forEach(msg => {
        if (msg.receiver_id === currentUser.id && msg.sender_id === userId) {
          msg.read = true;
        }
      });
      localStorage.setItem('avocado_messages', JSON.stringify(messages));

      // Scroll to bottom
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 0);

      // Update notification count
      const unreadCount = messages.filter(m => m.receiver_id === currentUser.id && !m.read).length;
      document.getElementById('notification-count').textContent = unreadCount;
    }

    function sendChatMessage(event) {
      event.preventDefault();

      if (!currentUser || !currentConversation) return;

      const content = document.getElementById('chat-input').value;
      if (!content.trim()) return;

      const message = {
        id: Date.now(),
        sender_id: currentUser.id,
        receiver_id: currentConversation.user_id,
        message: content,
        timestamp: new Date().toISOString(),
        read: false
      };

      const messages = JSON.parse(localStorage.getItem('avocado_messages')) || [];
      messages.push(message);
      localStorage.setItem('avocado_messages', JSON.stringify(messages));

      document.getElementById('chat-input').value = '';
      loadMessages(currentConversation.user_id);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (!currentUser) {
        openLoginModal();
      } else {
        loadConversations();
        updateUserUI();
      }
    });

    // Reload conversations periodically
    setInterval(() => {
      if (currentUser && !currentConversation) {
        loadConversations();
      }
    }, 3000);
  </script>
</body>
</html>
